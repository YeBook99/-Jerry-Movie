<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ss.cinema.mappers.TicketMapper">

	<resultMap type="movieDTO" id="movieListMap">
		<id property="movieNo" column="MOVIE_NO"/>
		<result property="movieTitle" column="MOVIE_TITLE"/>
		<result property="movieStartDate" column="MOVIE_START_DATE"/>
		<result property="movieEndDate" column="MOVIE_END_DATE"/>
		<result property="movieDirector" column="MOVIE_DIRECTOR"/>
		<result property="movieActor" column="MOVIE_ACTOR"/>
		<result property="movieGenre" column="MOVIE_GENRE"/>
		<result property="movieAgeLimit" column="MOVIE_AGE_LIMIT"/>
		<result property="movieShowtime" column="MOVIE_SHOWTIME"/>
		<result property="movieNationality" column="MOVIE_NATIONALITY"/>
		<result property="movieSummary" column="MOVIE_SUMMARY"/>
		<result property="movieImage" column="MOVIE_IMAGE"/>
		<result property="movieTrailer" column="MOVIE_TRAILER"/>
	</resultMap>
	
	<resultMap type="CinemaDTO" id="cinemaListMap">
		<id property="cinemaNo" column="CINEMA_NO"/>
		<result property="cinemaRLG" column="CINEMA_RLG"/>
		<result property="cinemaBLG" column="CINEMA_BLG"/>
		<result property="cinemaMovieNo" column="CINEMA_MOVIE_NO"/>
		<result property="cinemaScreenDate" column="CINEMA_SCREEN_DATE" javaType="java.sql.Date"/>
	</resultMap>
	
	<resultMap type="TheaterDTO" id="theaterListMap">
		<id property="theaterNo" column="THEATER_NO"/>
		<result property="theaterStartTime" column="THEATER_START_TIME"/>
		<result property="theaterEndTime" column="THEATER_END_TIME"/>
		<result property="theaterName" column="THEATER_NAME"/>
		<result property="theaterCinemaNo" column="THEATER_CINEMA_NO"/>
	</resultMap>


	<select id="getMovieList" resultMap="movieListMap" parameterType="map" >
			SELECT MOVIE_NO, MOVIE_TITLE, MOVIE_IMAGE, MOVIE_AGE_LIMIT
			FROM MOVIE M
            JOIN CINEMA C ON M.MOVIE_NO = C.CINEMA_MOVIE_NO
            LEFT JOIN TICKET T ON C.CINEMA_NO = T.TICKET_CINEMA_NO
			WHERE TO_CHAR(C.CINEMA_SCREEN_DATE,'YYYYMMDD')
			BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')+7
			<if test="movieNo != null">
				 AND M.MOVIE_NO = #{movieNo}
			</if>
			
			<if test="cinemaBLG != null">
				 AND C.CINEMA_BLG = #{cinemaBLG}
			</if>
			
			<if test="cinemaScreenDate != null">
				AND TO_CHAR(C.CINEMA_SCREEN_DATE, 'YYYY-MM-DD') = #{cinemaScreenDate}
			</if>
			GROUP BY MOVIE_NO, MOVIE_TITLE, MOVIE_IMAGE, MOVIE_AGE_LIMIT
			ORDER BY (SUM(NVL(T.TICKET_TEEN, 0)) + SUM(NVL(T.TICKET_ADULT, 0)) + SUM(NVL(T.TICKET_SENIOR, 0))) DESC
	</select>
	
	
	
	
	<select id="getCinemaList" resultMap="cinemaListMap" parameterType="map">
		SELECT CINEMA_RLG, CINEMA_BLG
		FROM CINEMA
		WHERE CINEMA_MOVIE_NO IN (
			SELECT C.CINEMA_MOVIE_NO
			FROM MOVIE M
            JOIN CINEMA C ON M.MOVIE_NO = C.CINEMA_MOVIE_NO
			WHERE TO_CHAR(C.CINEMA_SCREEN_DATE,'YYYYMMDD')
			BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')+7
			<if test="movieNo != null">
				 AND M.MOVIE_NO = #{movieNo}
			</if>
			
			<if test="cinemaBLG != null">
				 AND C.CINEMA_BLG = #{cinemaBLG}
			</if>
			
			<if test="cinemaScreenDate != null">
				AND TO_CHAR(C.CINEMA_SCREEN_DATE, 'YYYY-MM-DD') = #{cinemaScreenDate}
			</if>
			GROUP BY MOVIE_NO
		)
		<if test="cinemaScreenDate != null">
				AND TO_CHAR(CINEMA_SCREEN_DATE, 'YYYY-MM-DD') = #{cinemaScreenDate}
		</if>
		GROUP BY CINEMA_RLG, CINEMA_BLG
	</select>
	
	
	
	
	<select id="getCinemaDateList" resultMap="cinemaListMap" parameterType="map">
		SELECT CINEMA_SCREEN_DATE
		FROM CINEMA
		WHERE CINEMA_MOVIE_NO IN (
			SELECT C.CINEMA_MOVIE_NO
			FROM MOVIE M
            JOIN CINEMA C ON M.MOVIE_NO = C.CINEMA_MOVIE_NO
			WHERE TO_CHAR(C.CINEMA_SCREEN_DATE,'YYYYMMDD')
			BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')+7
			<if test="movieNo != null">
				 AND M.MOVIE_NO = #{movieNo}
			</if>
			
			<if test="cinemaBLG != null">
				 AND C.CINEMA_BLG = #{cinemaBLG}
			</if>
			
			<if test="cinemaScreenDate != null">
				AND TO_CHAR(C.CINEMA_SCREEN_DATE, 'YYYY-MM-DD') = #{cinemaScreenDate}
			</if>
			GROUP BY MOVIE_NO
		)
		<if test="cinemaBLG != null">
			AND CINEMA_BLG = #{cinemaBLG}
		</if>
		<if test="cinemaScreenDate != null">
			AND TO_CHAR(CINEMA_SCREEN_DATE, 'YYYY-MM-DD') = #{cinemaScreenDate}
		</if>
		GROUP BY CINEMA_SCREEN_DATE
	</select>
	
	

</mapper>

